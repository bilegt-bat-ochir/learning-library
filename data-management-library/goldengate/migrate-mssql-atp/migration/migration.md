# Migrate the source database

## Introduction

In the previous labs, we have configured Oracle GoldenGate Microservices for source and target databases. It is now time to migrate to target Autonomous Database. 

Many Oracle GoldenGate customers overlook the need to ensure that the source and target database schemas to be replicated are in sync. GoldenGate’s underlying architecture for data replication ensures 100% consistency for all changes that occur on the source database. For each change on the source, such as an update or delete, GoldenGate guarantees the transaction was completed on the target. If the data didn’t exist on the target for an update or delete, then the replication of the transaction will fail and stop with an abnormal error. Usually, first-time GoldenGate users don’t understand this guaranteed consistency architecture and expect that GoldenGate would ignore these errors by default. However, if this was the case, then the target data would never match the source data.

For the purposes of this lab, the source database is a SQL Server database and the target is Oracle Autonomous Database. There are five source tables in Parking schema and each table and associated resources, such as primary key constraints, will be created in the target schema as part of the target instantiation. 

*Estimated time*: 20 minutes

### Objectives

- To complete the lab, we will configure _**two extract**_ processes at the source database, _**two distribution path**_ from source, and _**two replicat**_ processes at the target database:

	![Architecture Diagram](/images/architecture.png)

* An extract for **changed data capture**. This process will start by capturing changes also create some files called trail files. We will use these files after the initial load finish at the target database. Let's call it **the primary extract** during this workshop. 

* The migration step needs another 'special' type of extract process while changes are being captured by the first extract process from the source database. This 'special' process is called the **Initial-Load extract**. It captures data from a specified list of tables and later will be loaded into target database tables.

	> **NOTE:** This is very simple initial-load method for purpose of this lab, because our source database size is small. The Oracle Database expdp and impdp are fully documented in the Oracle Documentation and it is preferred method of instantiation. You may also use [official instantiation document for this type of initial load](https://docs.oracle.com/en/middleware/goldengate/core/19.1/admin/instantiating-oracle-goldengate-initial-load.html#GUID-3AA4446C-6875-40BC-9944-006435FCF240)

* We will then need to send trail files which are generated by these two extracts to our target GoldenGate for Oracle Microservices. This step is called establishing a distribution path. One path for each extracts, therefore two distribution paths will be created.

* When the initial-load extract finishes at the source and successfully established a distribution path, we will create the first replicat process to apply those changes at the target database. We will call it **Initial-Load Replicat**, it is responsible for populating the target database using extracted data from the source database.

* The second replicat is for applying **changed data**. We will call it **the primary replicat**. Once the first replicat process, the initial-load finish, we will create a replicat process for applying changed data captured during or after the initial-load to the target database. 

### Prerequisites

* This lab assumes that you completed all preceding labs.

## **Task 1**: Log in to GoldenGate Microservices for SQL 

1. Let's add some extracts in GoldenGate for SQL. Open your web browser and point to `https://GG_MSSQL_PUBLIC_IP`. Provide oggadmin in username and password which you copied, then log in.

	![Connect to GoldenGate](/images/connect-mssql-1.png)

## **Task 2**: Configure the Primary Extract at the Source SQL

1. This is the **first** and primary extract, or should I say continuous extract process to initiate change data capture. In the administration server, click the **+** icon for adding the extract.

	![Add extract](/images/add-extract.png)

2. On the Add Extract page, select **Change Data Capture**, and then click Next.

	![](/images/add-extract-0.png)

3. Please provide **_`EXT1`_** as it is our primary extract in  **Process Name**. Click on the **Credentials Domain** drop-down list and choose **GoldenGate**. In the **Credential Alias**, choose **mssqlserver** from the drop-down list. In **Trail Name** field type **_`ex`_**, then click Next.

	![](/images/add-extract-1.png)

5. GoldenGate Microservices already has a draft parameter file for your convenience. You can modify the parameter according your schema and table names. Add the below line after the last line of the existing draft parameter:

	```
	<copy>
	TABLE parking.countries;
	TABLE parking.cities;
	TABLE parking.parkings;
	TABLE parking.parkingData;
	TABLE parking.paymentData;
	</copy>
	```

	Parameter file should be looking like the below image.

	![](/images/add-extract-3.png)

6. Make sure everything is correct until this stage. Click **Create and Run** to start our extract.

	![](/images/add-extract-4.png)

	> **NOTE:** You need to make sure [purge old trail files](https://docs.oracle.com/en/middleware/goldengate/core/21.3/ggmas/working-data-replications.html#GUID-41771EA7-8C7B-40D9-80EF-AF4DC0CA2FB5) in production scenario. The Purge Trail page works the same way as the Manager `PURGEOLDEXTRACTS` parameter in the Classic Architecture. It allows you to purge trail files when Oracle GoldenGate has finished processing them. Automating this task ensures that the trail files are periodically deleted to avoid excessive consumption of disk space. 

	After few seconds, the extract process will start capturing changes at the source database.

	![](/images/add-extract-5.png)

## **Task 3**: Configure the Initial-Load Extract at the Source SQL

1. Let's go back to the GoldenGate deployment console. In the administration server, click the **+** icon for adding an extract. This is the **second** and initial-load extract, which will extract all rows in tables into a file. On the Add Extract page, select **Initial Load Extract**, and then click Next.

	![Add Initial Load Extract](/images/add-initload.png)

2. In **Process Name**, please provide **_`initSRC`_** because this initial load extract. Click on the **Credentials Domain** drop-down list and choose **GoldenGate**. In the **Credential Alias**, choose **mssqlserver** from the drop-down list. In **Trail Name** field type **_`in`_**, then click Next.

	![Add Initial Load Extract](/images/add-initload-0.png)

3. Modify default parameter. Add the below line after the last line of the existing draft parameter:

	```
	<copy>
	TABLE parking.countries;
	TABLE parking.cities;
	TABLE parking.parkings;
	TABLE parking.parkingData;
	TABLE parking.paymentData;
	</copy>
	```

	Parameter file should be looking like the below image.

	![](/images/add-initload-2.png)

4. Make sure everything is correct and lick **Create and Run** to start our initial-load extract.

	![](/images/add-initload-3.png)

5. In the overview dashboard, you should see **initSRC** extract is stopped. Click on **Action** button, choose **Details**. Initial-load takes only a matter of seconds to finish sample 5 tables. You can see actual extract process details in the **Report** tab. Please refer to the below recording for your reference of this step.

	![](/images/add-initload-4.png)

	_RECAP:_ So far, we have configured two extract processes. EXT1 is capturing change data and INITSRC captured every row of the source five tables. Now we need to establish a connection between two GoldenGate Microservices. We will be sending captured trail files from GoldenGate Microservices for **SQL** to GoldenGate Microservices for **Oracle**.

## **Task 4**: Configure Distribution Paths between Microservices

A distribution path defines the route for the trail to send and receive data. Basically, the path between a source and target deployment will be used to send the transaction of data from the Extract processes to the Replicats. Paths can be initiated from the Distribution Server to the Receiver Service. We will create two distribution paths from Source GoldenGate server to Target GoldenGate server. It is called **Source-Initiated distribution path**.

1. Open the Distribution Server. Click the plus **(+)** sign next to Path on the Distribution Server home page. 
	
	![Add distribution](/images/add-distribution-0.png)

2. The Add Path page is displayed. Provide **EXT1** for the path name. Select source extract **EXT1** from the drop-down list and also trail file name **ex**. Scroll down to **Target**, we will use regular **ogg** protocol. For the ogg protocol, you need to specify your target host *IP address*, port number *9013*, and trail file name *ex*.

	![Add distribution](/images/add-distribution.png)

2. Since we used ogg protocol, we **must ensure** our target server type is a **Receiver Service** and click **Create and Run**.

	![Choose Receiver Service](/images/add-distribution-1-1.png)

3. Now we will create the **second** distribution path. Click again the plus **(+)** sign. Provide **INITLOAD** for the path name. But **_don't choose_** source extract name, instead write trail file name **_in_** manually. 
	Scroll down to **Target**, we will use regular **ogg** protocol. You also need to specify your target host *IP address*, port number *9013*, and trail file name *in*.

	![Add distribution](/images/add-distribution-initload.png)

2. Since we used ogg protocol, we **must ensure** our target server type is a **Receiver Service** and click **Create and Run**.

	![Choose Receiver Service](/images/add-distribution-1-1.png)

3. You should have two distribution processes after this step.

	![Paths](/images/add-distribution-2.png)

	Succesfully established paths will ensure that you will be sending captured trail files to the target GoldenGate deployment. 

## **Task 5**: Log in to GoldenGate Microservices for Oracle Databse 

1. Now it is time to add the replicats in GoldenGate for Oracle. Open your web browser and point to `https://GG_ORACLE_PUBLIC_IP`. Provide oggadmin in username and password which you copied, then log in.

	![Connect to GoldenGate](/images/connect-oracle-1.png)

## **Task 6**: Configure the Initial-Load Replicat at the Target Oracle Database

1. The apply process for replication, also known as Replicat, is very easy and simple to configure. There are four types of Replicats supported by the Oracle GoldenGate Microservices. On the overview page, go to Replicat part and click on **+** to create our replicat process.

	![Create replicat process](/images/add-replicat.png)

2. We will choose **Non-Integrated Replicat** for initial load, click **Next**. In non-integrated mode, the replicat process uses the standard SQL to apply data directly to the target tables. In our case, the number of records in the source database is small and we don't need to run in parallel, therefore it will suffice.

	![Add non-integrated replicat](/images/add-replicat-1.png)

3. Provide a name for the replicat process, which has to be unique and 8 characters long. It is better if you give some meaningful names to identify them later on. Let's name it **initload**, because this is currently our initial load process.

	![Name replicat process](/images/add-replicat-2.png)

4. Then click on the **Credentials Domain** drop-down list. There is only one credential at the moment, choose the available option for you. In the **Credential Alias**, choose **hol_tp** from the drop-down, which is the pre-created connection group to target ATP. 

	![Credentials domain screen](/images/add-replicat-2-2.png)

5. Scroll below and find "Trail Name", add _**in**_ as trail name, because we defined this in our distribution path parameter, so it _**cannot**_ be just a random name. Also provide **/u02/trails** in the "Trail Subdirectory" and choose a Checkpoint Table from the drop-down list. It is **GGADMIN.CHKPT** in our case. Review everything then click **Next**

	![Add previously defined trial name](/images/add-replicat-2-1.png)

6. Microservices has created a draft parameter file for your convenience. Erase the last line from the existing draft parameter, then add below configuration instead:

	```
	<copy>
	MAP parking.Countries, TARGET parking.Countries;
	MAP parking.Cities, TARGET parking.Cities;
	MAP parking.Parkings, TARGET parking.Parkings;
	MAP parking.ParkingData, TARGET parking.ParkingData;
	MAP parking.PaymentData, TARGET parking.PaymentData;
	</copy>
	```

	Parameter file should be looking like the below image.

	![Parameter file showing the configuration](/images/add-replicat-3.png)

7. Make sure everything is correct until this stage. Click **Create and Run** to start our replicat.

	![Running Initload](/images/add-replicat-4.png)

8. Similar to the extract processes, go and see the detail of the **initload** process. In the statistics tab, you will see how many rows were inserted by the replicat. You can also check more detailed information in the Report tab.

	![View statistics of replicat](/images/add-replicat-stats.png)

## **Task 8**: Run Update Statement at The Source Database.

1. Okay, now let's make some changes in the source database to make this migration closer to a real-life scenario. You found out that there was an error in your source database. Data seems wrong or missing some characters in the source database. However, you have an extract process which supposedly capture all of your changes. 

	![Production data](/images/update-check.png)

2. Let's test if **EXT1** extract process is running properly. Go to your source database and run the below statement to correct the data on the source side.

	```
	<copy>
	update [parking].[Cities] set City = 'Ploiesti' where City='Plo';
	</copy>
	```

	![Production data](/images/update-check-1.png)

	This statement updates a row in cities table. Also, it must have captured by the **EXT1** process at the GoldenGate for SQL server. We now need to create the second replicat process to apply this captured changes to the target database.

## **Task 7**: Configure the Continuous Replicat at the Target Oracle Database

1. This is the **second** and primary replicat, or should I say continuous replicat process to apply captured data. In the administration server, click the **+** icon for adding the replicat.

	![Add replicat](/images/add-repcont.png)

2. We will choose **Non-Integrated Replicat** mode, click **Next**.

	![Add non-integrated replicat](/images/add-replicat-1.png)

3. Provide a name for the replicat process, for example, **_`REPCONT`_**, because this will be our continuous replication process.

	![Give a name to replicat](/images/add-repcont-2.png)

4. Then click on the **Credentials Domain** drop-down list. There is only one credential at the moment, choose the available option for you. In the **Credential Alias**, choose **hol_tp** from the drop-down, which is the pre-created connection group to target ATP. 

	![Credentials domain screen](/images/add-replicat-2-2.png)

5. Scroll below and find "Trail Name", add _**ex**_ as trail name, because we defined this in our distribution path parameter, so it _**cannot**_ be just a random name. Also provide **/u02/trails** in the "Trail Subdirectory" and choose a Checkpoint Table from the drop-down list. It is **GGADMIN.CHKPT** in our case. Review everything then click **Next**

	![Add previously defined trial name](/images/add-repcont-3.png)

6. Microservices has created a draft parameter file. Erase the last line from the existing draft parameter, then add below configuration instead:

	```
	<copy>
	MAP parking.Countries, TARGET parking.Countries;
	MAP parking.Cities, TARGET parking.Cities;
	MAP parking.Parkings, TARGET parking.Parkings;
	MAP parking.ParkingData, TARGET parking.ParkingData;
	MAP parking.PaymentData, TARGET parking.PaymentData;
	</copy>
	```

	Parameter file should be looking like the below image.

	![Parameter file showing the configuration](/images/add-repcont-4.png)

7. Make sure everything is correct until this stage. Click **Create and Run** to start our replicat.

	![Running Repcont](/images/add-repcont-5.png)

8. You can open the detail of the **REPCONT** process. In the statistics tab, you will see how many rows were updated by the replicat. You can also check more detailed information in the Report tab.

	![Statistics tab](/images/add-repcont-stats.png)

	Congratulations, you completed this workshop!

## **APPENDIX**: ERRORS

### **ERROR CODE** : OGG-05361  
1. The SQL Server CDC cleanup job exists on database warrior, which indicates that an Oracle GoldenGate purge change data task has not been enabled. Ensure that a purge change data task is enabled to allow Oracle GoldenGate to manage CDC cleanup. You need to run the below in the SQL Management Studio:

	```
	EXECUTE sys.sp_cdc_drop_job 'cleanup';
	```

	![Error fix](/images/cleanup-job.png)


## Acknowledgements

I would like to thank Tsengel Ikhbayar, GenO lift implementation engineers. He have shown their dedication and hard work to support my workshop.

* **Author** - Bilegt Bat-Ochir - Senior Technology Solution Engineer
* **Contributors** - Tsengel Ikhbayar - GenO lift implementation
* **Last Updated By/Date** - Bilegt Bat-Ochir 08/04/2022